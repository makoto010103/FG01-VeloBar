# VeloBar チェンジログ (CHANGELOG)

## v3.2.9 (2026-02-20)
- **バウンス・ロックアウト干渉の解決**:
    - バウンス（反動）として弾かれたノイズが、次のレップの不感時間を上書きして開始を遅らせてしまう問題を解決。ノイズではタイマーがリセットされないようにしました。
    - バウンスフィルターの適用開始を「1レップ目終了後」からに早め、より初期からノイズを除去。
    - 不感時間を1.0秒にバランス調整。

## v3.2.8 (2026-02-20)
- **バウンスノイズ対策**: 
    - 不感時間を400ms→1200msに再調整。挙上後の反動がレップとして誤カウントされる問題を解決。
    - ベスト速度の40%以下のピークを「バウンスノイズ」として自動排除するフィルターを追加。
    - ログに `⚠️ Bounce filtered` と表示され、排除理由が確認可能。

## v3.2.7 (2026-02-20)
- **【致命的バグ修正】レップ判定ロジックの完全書き直し**: 
    - **閉じ括弧の欠落（構文エラー）**: v3.2.6の修正で導入されたブラケットの不整合により、レップ判定コード全体がJavaScriptパースエラーで動作していなかった可能性を修正。
    - **速度ギャップ問題の解消**: 速度がEND_THRESHOLD(0.05)とSTART_THRESHOLD(0.12)の間にある時、終了カウンターがリセットされず判定がスタックする問題を修正。新たに「中間ゾーン」ブランチを追加し、この範囲では「まだ動いている」と正しく判定。
    - 不感時間を1500ms→400msに短縮。終了閾値を0.05に引き下げ。
    - デバッグログに、レップ確定時の持続時間と、却下時の理由を絵文字付きで表示。

## v3.2.6 (2026-02-20)
- **レップ判定の安定性を大幅向上**: 
    - セット間の「自動リセット（静止判定）」時間を5秒から30秒へ大幅に延長。100kgスクワット等の高重量トレーニングで、次のレップへのセットアップ中にデータが消える問題を解決。
    - レップ開始閾値を0.15→0.12に、終了閾値を0.12→0.10に引き下げ、より微細な挙上動作も確実にキャッチ。
    - SQ（スクワット）の最小ピーク閾値を0.35→0.25に調整し、粘るようなスローな挙上でもカウントされるよう改善。
    - ログ機能に「レップ確定」および「無効なレップの理由」を表示するデバッグ機能を追加。
- **グラフ表示の最適化**: 
    - 波形の横幅を拡大（表示時間を12秒→8秒に短縮）し、挙上の動きをより詳細に観察可能に改善。
    - グラフの底辺を0m/sに固定。マイナス方向の表示を廃止し、挙上速度の視認性を向上。
    - 縦軸のスケールを3.0m/sに調整し、主要なVBT種目で最適なスケール感を実現。

## v3.2.5 (2026-02-20)
- **レップ判定ロジックの修正**: アプリ側 (`index.html`) で挙上時間 (`duration`) の定義が漏れていたバグを修正。これにより時間ベースのノイズフィルタリングが正しく機能するように復旧。
- **データ分析による動作確認**: 提供された100kgスクワットのデータに基づき、不感時間（ロックアウト）と静止時の速度減衰（Soft ZUPT）が正常に機能していることを確認。

## v3.2.4 (2026-02-20)
- **レップ検出バグの修正**: レップ終了時に不感時間の計算ベース（lastRepTime）が更新されていなかった重大なミスを修正。これにより「1.5秒の不感時間」が正しく機能するようになり、挙上直後の揺れによる誤検知を完全にシャットアウト。
- **ファームウェアの残留速度除去能力を2.5倍に強化**: 静止時の速度減衰係数を0.998→0.995に変更。激しい動きの後の速度収束を劇的に早めました。
- **超高重量対応**: 加速度ノイズしきい値を0.06Gに引き上げ、担いで立っている際の細かな筋肉の震え（シバリング）を無視するように調整。

## v3.2.3 (2026-02-20)
- **「えぐいドリフト」への徹底対策**: 
    - 静止判定（ZUPT）の加速度閾値を0.1G→0.25Gに緩和。高重量担ぎ時の微振動でも静止とみなせるように改善。
    - 速度積分に「自然減衰（リーキー積分）」を導入。動作していない時の微小な計算誤差が蓄積するのを物理的に防ぐ。
    - プログラム内の経過時間（dt）計算のガード値を調整。通信遅延による計算飛びを抑制。
- **ノイズ除去強化**: 加速度のデッドゾーンを広げ、震えによる速度増加をシャットアウト。

## v3.2.2 (2026-02-20)
- **挙上後の誤検知対策を強化**: 挙上直後の「揺れ・弾み」を拾わないよう不感時間（LOCKOUT_MS）を250ms→1200msに大幅延長。
- **ノイズフィルタリング改善**: 最小継続時間（MIN_DURATION_MS）を300ms→350msに調整し、単発の衝撃音的なノイズを排除。
