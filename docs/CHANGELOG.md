# VeloBar チェンジログ (CHANGELOG)

## v3.2.3 (2026-02-20)
- **「えぐいドリフト」への徹底対策**: 
    - 静止判定（ZUPT）の加速度閾値を0.1G→0.25Gに緩和。高重量担ぎ時の微振動でも静止とみなせるように改善。
    - 速度積分に「自然減衰（リーキー積分）」を導入。動作していない時の微小な計算誤差が蓄積するのを物理的に防ぐ。
    - プログラム内の経過時間（dt）計算のガード値を調整。通信遅延による計算飛びを抑制。
- **ノイズ除去強化**: 加速度のデッドゾーンを広げ、震えによる速度増加をシャットアウト。

## v3.2.2 (2026-02-20)
- **挙上後の誤検知対策を強化**: 挙上直後の「揺れ・弾み」を拾わないよう不感時間（LOCKOUT_MS）を250ms→1200msに大幅延長。
- **ノイズフィルタリング改善**: 最小継続時間（MIN_DURATION_MS）を300ms→350msに調整し、単発の衝撃音的なノイズを排除。

## v3.2.1 (2026-02-20) — ファームウェア修正
### 🐛 バグ修正
- **[致命的] ZUPT `static_frames` シャドーイングバグ修正**: `else`節内の`static int static_frames = 0;`が新しいローカル変数を宣言するだけで、実際のカウンターをリセットしていなかった。一度ZUPTが発動すると二度と解除されず、動作中に`velocity *= 0.8`の減衰が不正適用されてピーク速度が過小評価される原因だった。グローバル変数`zupt_static_frames`に修正。

### 🔧 改善
- **Madgwickフィルターのサンプリングレートを動的計測**: `filter.begin(100.0f)`の固定値から、実際のloop()実行頻度を1秒ごとに計測して反映するように変更。`delay(5)`による実際のレート（~130-150Hz）との不一致を解消。
- **ZUPT判定にacc_mag条件を追加**: ジャイロ5dps未満に加え、加速度の大きさが1G付近（0.95～1.05G）であることを静止の条件に追加。動作中の誤判定を防止。
- **ZUPT継続フレーム数を20→25に変更**: 静止判定をより慎重にし、レップ間の短い停止での誤発動を抑制。
- **回転クランプのしきい値を200dps→300dpsに引き上げ**: ベンチプレスの通常動作でも200dps付近が出る可能性があったため、より保守的に変更。
- **回転クランプの速度減衰を0.9→0.95に緩和**: 過剰な速度抑制を防止。
- **ノイズしきい値を0.02→0.015 m/s²に微調整**: より微小な加速度変化を検出可能に。
- **dt計算の異常値ガードを強化**: 0.5ms～50msの範囲に制限し、BLE割り込み等による異常値を排除。
- **デバッグログ強化**: `is_static`状態、`zupt_static_frames`カウンター値、`dt`（ms）、実効サンプリングレート（Hz）をシリアル出力に追加。

### 📋 原因分析メモ
提供されたCSVデータ（BP 60kg）で以下の交互パターンが観測された:
- Rep 1: 1.023 m/s → Rep 2: 0.378 m/s → Rep 3: 0.837 m/s → Rep 4: 0.518 m/s
- 奇数レップが高く、偶数レップが著しく低い不自然なパターン
- 主原因: `static_frames`のC++シャドーイングバグにより、ZUPT解除が正常に行われず、動作中に速度減衰が不正適用されていた

## v3.2.0 (2026-02-20)
- 種目別の速度閾値を実装（BP=0.25, SQ=0.35, CL=0.50, DL=0.30 m/s）
- 上限速度フィルター追加（ラック戻し誤検出防止）
- SE音量を2〜4倍に増加
- ストップ音を4連の高周波アラーム（ピピピピ！）に変更
- ワーニング音をダブルビープに変更
- モードセレクタにVL閾値%を表記
- セマンティックバージョニング（x.y.z）に移行

## v3.1 (2026-02-19)
- Min Peak閾値を0.15→0.50に引き上げ（下ろしフェーズの誤検出防止）
- Critical Drop判定をsetBestVelocity基準に変更
- 5秒カウントダウンオーバーレイ追加（ラックアップ誤検出防止）
- カウントダウンに音声フィードバック（ビープ音）追加
- CSVエクスポートにraw速度タイムシリーズデータを含める

## v3.0 (2026-02-19)
- Cyber UIテーマに全面リニューアル
- VBT Judgment Engine実装（パワー/筋力/筋肥大モード）
- Velocity Loss（疲労度）リアルタイム計算
- Set Best Velocity ロック機能（Rep 1-2で確定）
- 音声通知セレクタ（ベル/ゲーム/電子音/機械音/なし）
- 種目・重量セレクタ、Rep手動補正、クリップボードエクスポート
- UI全体を日本語化

## v2.2 (2026-02-18)
- ヘッダーをウルトラコンパクト化
- Rep間の%変化を表示
- Rep検出の最小継続時間を調整

## v2.1 (2026-02-17)
- エキセントリック速度フィルター（負の値を0.0表示）
- ノイズダンピング改善
- グラフの表示範囲調整（12秒ウィンドウ）

## v2.0 (2026-02-16)
- BLEレートを50Hzに増加
- Rep検出ロジック改善（最小継続時間、ロックアウト）
- グラフスケール調整

## v1.x (2026-02-14 〜 2026-02-16)
- 初期プロトタイプ
- Seeed XIAO nRF52840 + ICM-42688 によるIMUベース速度計測
- BLE接続によるリアルタイム速度送信
- カスタムCanvasグラフプロッター
- 適応的重力補正
- Raw波形記録・CSVエクスポート
- ウォッチドッグタイマー・BLE安定化
